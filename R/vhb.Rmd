--- 
title: "MATA'EA, French Polynesia"
subtitle: "VHB"
output:  
  html_document: 
    mode: selfcontained
    toc: yes 
    toc_float: true
    number_sections: false
    theme: flatly
fig_width: 12 
fig_caption: FALSE 
--- 
  
```{r setup, include=FALSE} 
# Chapter 1
# Set options, load data, utility functions 
knitr::opts_chunk$set(
  echo = FALSE,
  results = "asis",
  message = FALSE,
  warning = FALSE
)
library(data.table)
library(here)
library(haven)
library(knitr)
library(gtsummary)
library(flextable)
library(survey)
library(gt)
theme_gtsummary_language('en')
theme_gtsummary_journal('lancet')

load(here('data/rep.rdata'))

```


## 5.1 VHB serological profiles

### Table 5.1.1 VHB profiles in French Polynesia

```{r tab_5_1_1}

d5 <- survey::svydesign(
  id = ~ subjid,
  weights = ~ w.vhb,
  strata = ~ geo + agegr,
  data = mata[!is.na(vhb), .(
    subjid,
    w.vhb,
    geo=relevel(factor(geo), ref="Société (Îles-du-vent)"),
    marquises,
    australes,
    agegr,
    age,
    date.vx,
    sex=relevel(factor(sex), ref="Female"),
    edu,
    civil,
    ethnicity=relevel(factor(ethnicity), ref="Caucasian"),
    hh,
    hhc,
    bmi,
    bm,
    bm2,
    overweight,
    obese,
    denv1,
    denv2,
    denv3,
    denv4,
    zikv,
    chikv,
    rrv,
    vhb,
    vhb.HBs,
    vhb.alltime,
    fib4,
    diabetes,
    hyperchol
  )]
)


tbl_svysummary(d5,
               include = c(vhb),
               missing='no',
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(stat_0 = "**VHB profile (95% CI)**") |>
  bold_labels() |>  
  remove_row_type(type='header')

```



### Table 5.1.2 VHB sero profiles by sex

```{r tab_5_1_2}
tbl_svysummary(d5,
               include = c(vhb),
               missing = 'no',
               by = sex,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**VHB**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type='header')

```


### Table 5.1.3 VHB sero profiles by age group

```{r tab_5_1_3}
tbl_svysummary(d5,
               include = c(vhb),
               missing = 'no',
               by = agegr,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**VHB**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type='header')

```


### Table 5.1.4 VHB sero profiles by archipelago

```{r tab_5_1_4}
tbl_svysummary(d5,
               include = c(vhb),
               missing = 'no',
               by = geo,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**VHB**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type='header')

```


### Table 5.1.5 VHB sero profiles by Education level

```{r tab_5_1_5}
tbl_svysummary(d5,
               include = c(vhb),
               missing = 'no',
               by = edu,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**VHB**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type='header')

```


### Table 5.1.6 VHB sero profiles by ethnicity

```{r tab_5_1_6}
tbl_svysummary(d5,
               include = c(vhb),
               missing = 'no',
               by = ethnicity,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**VHB**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type='header')

```

### Table 5.1.7 VHB sero profiles by civil status

```{r tab_5_1_7}
tbl_svysummary(d5,
               include = c(vhb),
               missing = 'no',
               by = civil,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**VHB**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type='header')

```

### Table 5.1.8 VHB sero profiles by house size category

```{r tab_5_1_8}
tbl_svysummary(d5,
               include = c(vhb),
               missing = 'no',
               by = hhc,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**VHB**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type='header')

```


## 5.2 All-time VHB infections

### Table 5.2.1 All-time VHB infections in French Polynesia

```{r tab_5_2_1}

tbl_svysummary(d5,
               include = (vhb.alltime),
               missing='no',
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(stat_0 = "**All-time VHB infection (95% CI)**") |>
  bold_labels() |>  
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```

### Table 5.2.2 All-time VHB infections by sex

```{r tab_5_2_2}
tbl_svysummary(d5,
               include = c(vhb.alltime),
               missing = 'no',
               by = sex,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**All-time VHB infection**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```


### Table 5.2.3 All-time VHB infections by age group

```{r tab_5_2_3}
tbl_svysummary(d5,
               include = c(vhb.alltime),
               missing = 'no',
               by = agegr,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**All-time VHB infection**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```


### Table 5.2.4 All-time VHB infections by archipelago

```{r tab_5_2_4}
tbl_svysummary(d5,
               include = c(vhb.alltime),
               missing = 'no',
               by = geo,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**All-time VHB infection**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```



### Table 5.2.5 All-time VHB sero profiles by Education level

```{r tab_5_2_5}
tbl_svysummary(d5,
               include = c(vhb.alltime),
               missing = 'no',
               by = edu,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**VHB**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```


### Table 5.2.6 All-time VHB sero profiles by ethnicity

```{r tab_5_2_6}
tbl_svysummary(d5,
               include = c(vhb.alltime),
               missing = 'no',
               by = ethnicity,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**VHB**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```

### Table 5.2.7 All-time VHB sero profiles by civil status

```{r tab_5_2_7}
tbl_svysummary(d5,
               include = c(vhb.alltime),
               missing = 'no',
               by = civil,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**VHB**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```

### Table 5.2.8 All-time VHB sero profiles by house size category

```{r tab_5_2_8}
tbl_svysummary(d5,
               include = c(vhb.alltime),
               missing = 'no',
               by = hhc,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**VHB**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```





## 5.3 Analysis of risk factors 

### Table 5.3.1 HBS carrier, quasi-binomial regressions (bivariate and multivariate) ajusted for sampling design effects

```{r tab_5_3_1}

t1 <- tbl_uvregression(
  d5,
  method = svyglm,
  label = list(
    geo ~ "Archipelago",
    sex ~ "Sex",
    age ~ "Age",
    edu ~ "Education",
    civil ~ "Civil status"
  ),
  include = c('geo', 'sex', 'age', 'edu', 'civil'),
  hide_n = TRUE,
  y = vhb.HBs,
  method.args = list(family = quasibinomial),
  exponentiate = TRUE
) |>
  add_global_p() |>
  modify_header(update = list(estimate ~ "**OR (IC 95%)**")) |>
  modify_footnote(estimate = "OR = rapport de cotes, IC = intervalle de confiance", abbreviation = TRUE)
# add_significance_stars(hide_se = TRUE,
#                        hide_p = FALSE,
#                        pattern = "{p.value}{stars}")

m <-
  svyglm(
    vhb.HBs ~ geo + sex + age + edu + civil,
    design = d5,
    family = "quasibinomial"
  )

t2 <- tbl_regression(
  m,
  label = list(
    geo ~ "Archipelago",
    sex ~ "Sex",
    age ~ "Age",
    edu ~ "Education",
    civil ~ "Civil status"
  ),
  exponentiate = TRUE
) |>
  modify_header(update = list(estimate ~ "**aOR (IC 95%)**")) |>
  modify_footnote(estimate = "aOR = Adjusted odds ratio", abbreviation = TRUE) |>
  add_global_p()
# add_significance_stars(
#   hide_se = TRUE,
#   hide_p = FALSE,
#   pattern = "{p.value}{stars}"
# )
# modify_footnote(everything() ~ NA, abbreviation = TRUE)

tbl_merge(
  tbls        = list(t1, t2),
  tab_spanner = c("**Univariate analysis**", "**Multivariate analysis**")
)

```


### Table 5.3.2 All-time infection, quasi-binomial regressions (bivariate and multivariate) ajusted for sampling design effects

```{r tab_5_3_2}
t1 <- tbl_uvregression(
  d5,
  method = svyglm,
  label = list(
    geo ~ "Archipelago",
    sex ~ "Sex",
    date.vx ~ "Born before vaccination policy",
    age ~ "Age",
    edu ~ "Education",
    ethnicity ~ "Ethnic group",
    civil ~ "Civil status"
  ),
  include = c('geo', 'sex', 'date.vx', 'age', 'ethnicity', 'edu', 'civil'),
  hide_n = TRUE,
  y = vhb.alltime,
  method.args = list(family = quasibinomial),
  exponentiate = TRUE
) |>
  add_global_p() |>
  modify_header(update = list(estimate ~ "**OR (IC 95%)**")) |>
  modify_footnote(estimate = "OR = rapport de cotes, IC = intervalle de confiance", abbreviation = TRUE)
# add_significance_stars(hide_se = TRUE,
#                        hide_p = FALSE,
#                        pattern = "{p.value}{stars}")

m <-
  svyglm(
    vhb.alltime ~ geo + sex + date.vx + age + ethnicity + edu + civil,
    design = d5,
    family = "quasibinomial"
  )

t2 <- tbl_regression(
  m,
  label = list(
    geo ~ "Archipelago",
    sex ~ "Sex",
    date.vx ~ "Born before vaccination policy",
    age ~ "Age",
    edu ~ "Education",
    ethnicity ~ "Ethnic group",
    civil ~ "Civil status"
  ),
  exponentiate = TRUE
) |>
  modify_header(update = list(estimate ~ "**aOR (IC 95%)**")) |>
  modify_footnote(estimate = "aOR = Adjusted odds ratio", abbreviation = TRUE) |>
  add_global_p()
# add_significance_stars(
#   hide_se = TRUE,
#   hide_p = FALSE,
#   pattern = "{p.value}{stars}"
# )
# modify_footnote(everything() ~ NA, abbreviation = TRUE)

tbl_merge(
  tbls        = list(t1, t2),
  tab_spanner = c("**Univariate analysis**", "**Multivariate analysis**")
)


```




## 5.4 Fib-4 categories

### Table 5.4.1 Distribution of Fib-4 categories in French Polynesia

```{r tab_5_4_1}

tbl_svysummary(d5,
               include = (fib4),
               missing='no',
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(stat_0 = "**Fib-4 categories (95% CI)**") |>
  bold_labels() |>  
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```

### Table 5.4.2 Fib-4 categories by all-time HbS

```{r tab_5_4_2}
tbl_svysummary(d5,
               include = c(fib4),
               missing = 'no',
               by = vhb.alltime,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**Fib-4 categories**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```


### Table 5.4.3 Fib-4 categories by diabetes status

```{r tab_5_4_3}
tbl_svysummary(d5,
               include = c(fib4),
               missing = 'no',
               by = diabetes,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**Fib-4 categories**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```


### Table 5.4.4 Fib-4 categories by obesity status

```{r tab_5_4_4}
tbl_svysummary(d5,
               include = c(fib4),
               missing = 'no',
               by = obese,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**Fib-4 categories**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```

### Table 5.4.5 Fib-4 categories by hypercholesterolemia status

```{r tab_5_4_5}
tbl_svysummary(d5,
               include = c(fib4),
               missing = 'no',
               by = hyperchol,
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**Fib-4 categories**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() |>
  remove_row_type(type = 'level', level_value = 'Negative') |>
  remove_row_type(type='header')

```



